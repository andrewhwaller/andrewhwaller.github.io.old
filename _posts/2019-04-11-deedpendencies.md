---
layout: post
title: OpenURI, URLs, and Mis(re)direction
---
When building Deedveloper(https://github.com/andrewhwaller/deedveloper), one of the functions that I needed to add was the ability to not only scrape an initial page of search results in Indeed.com, but also the ability to scrape the pages of individual job listings for more detailed information. I designed my scraper method to pull a truncated URL for each job using Nokogiri; this truncated address would then be appended to "http://indeed.com" to form a full and accessible URL for each job posting. A separate scrape_detail method would then take that posting's URL and parse it with Nokogiri to scrape additional information about the job. This is where things get tricky. For certain job postings, Indeed's URLs were redirecting from an HTTPS URL to an HTTP URL; this would caused OpenURI to throw a runtime error. Since redirecting from HTTPS to HTTP is sometimes considered unsafe, open-uri simply wouldn't allow this to happen.

This situation left me with quite the conundrum! OpenURI was a key part of my scraper methods, not to mention the fact that the open-uri library is conveniently built into Ruby itself. However, this error was preventing my code from functioning, so I had to find some sort of workaround.

My first stop was HTTParty(https://github.com/jnunemaker/httparty). This gem performs the same functions as OpenURI; the main difference is that it doesn't ship with Ruby. No problem, I thought. I had seen HTTParty used in some scraping tutorials on YouTube and it seemed pretty straightforward. I installed HTTParty, inserted the necessary requires, and set about adapting my code to work with this open-uri alternative. However, even after getting HTTParty integrated into my code, I began seeing two different issues. First of all, I was still getting redirect errors. This time, HTTParty was being redirected too many times and throwing the following error: Exception: HTTParty::RedirectionTooDeep. Not encouraging. It became apparent that HTTPS to HTTP redirection wasn't just a problem for OpenURI. HTTParty wasn't quite the viable alternative that I'd hoped it would be. Second, HTTParty causing my application to run significantly slower. This may have been due to the redirection issue, but even when filtering out problematic URLs, the scraper methods were noticeably laggy. At this point, my choice was to find a workaround for HTTParty and deal with the laggy runtime or find some other way to make my code function as expected.

Enter OpenURIRedirections (https://github.com/open-uri-redirections/open_uri_redirections). OpenURIRedirections is essentially a patch that addresses precisely the error I was trying to overcome: runtime errors due to problematic redirection. After implementing OpenURIRedirections, I was able to use a tag in my code that would override OpenURI's aversion to unsafe redirections and allow the redirection to proceed. Furthermore, OpenURIRedirections has the added benefit of simply patching OpenURI rather than replacing it. By using OpenURIRedirections instead of HTTParty, I was able to eliminate the lag that I had noticed previously.

Overall, this experience showed me the value of a simple native solution as opposed to a magical fix-all external gem. Although I suspect that some sort of solution using HTTParty could have been achieved, I was delighted to arrive at a fix that could make use of OpenURI rather than an additional gem. My code was released from its redirection prison by a simple tag! This resulted in a cleaner, quicker-running application that would limit the number of extra dependencies/required gems for future users.
